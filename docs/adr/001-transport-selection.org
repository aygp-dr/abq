#+TITLE: ADR-001: Transport Selection
#+DATE: 2025-01-28
#+STATUS: Accepted

* Status

Accepted

* Date

2025-01-28

* Context

We need to coordinate AI agents across repositories/worktrees on the same machine. Primary use case: test agent signals app agent when tests complete (~2 messages/day).

* Options Considered

** Option 1: Enterprise Message Bus

- 6 Kafka brokers (HA)
- 3-node ZooKeeper ensemble (or KRaft)
- Schema Registry (Avro)
- Kafka Connect (filesystem sink for debugging)
- Cruise Control (rebalancing)
- Burrow (consumer lag monitoring)
- Prometheus + Grafana (observability)
- Jaeger (distributed tracing)

*Estimated cost*: $847/month
*Ops burden*: High (dedicated platform team recommended)
*Resume impact*: Excellent

** Option 2: Write JSON to a Folder

#+begin_src bash
echo '{"done":true}' > ~/.abq/channels/app/requests/req_001.json
#+end_src

*Estimated cost*: $0
*Ops burden*: =ls=
*Resume impact*: Negligible

* Decision

Option 2.

* Rationale

- The failure mode is "I can literally =ls= the queue and see what's stuck"
- Debuggable with =cat= and =jq=
- Works from any language that can write files
- Survives restarts (it's just files)
- No daemon to babysit
- Polling at 100ms is fine for "tests finished"

* Consequences

- LinkedIn will not be impressed
- Cannot attend KafkaSummit as a speaker
- Will need to find other ways to mass overkill in Q3

* Observability Gap (Accepted Risk)

We lack distributed tracing for the 47-character journey from =requests/= to =processing/=. We may never know if a message briefly paused to contemplate existence between directories.

Will revisit if we scale to 3 messages/day.

* Post-Implementation Update (2026-01-28)

** Actual Usage Metrics

| Metric | Projected | Actual |
|--------|-----------|--------|
| Messages/day | ~2 | ~0.07 (2/month, if we remember) |
| Cross-machine | No | Yes (hydra â†” nexus via SCP) |
| Kafka instances | 0 | 0 |
| 3 AM pages | 0 | 0 |

** Revised Options

| Option | Complexity | Our Volume |
|--------|------------|------------|
| Kafka | 6 brokers, ZK, Schema Registry | lol |
| ABQ | JSON files in ~/.abq | maybe overkill |
| beads | =bd create "hey nexus, tests passed"= | probably sufficient |
| Slack DM | "yo tests passed" | honestly? |

** New Architecture Diagram

#+begin_example
nexus$ scp msg.json hydra:~/.abq/channels/x/requests/
#+end_example

Still no Kafka.

* References

- [[https://github.com/steveyegge/efrit][Efrit queue system]]
- [[https://en.wikipedia.org/wiki/Spooling][Unix spool pattern]]
- The look on someone's face when you say "it's a folder" and they wait for the rest of the sentence
